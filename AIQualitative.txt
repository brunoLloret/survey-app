import { ANTHROPIC_API_KEY } from '../config';

async function analyzeSurveyResponse(openEndedResponse: string, context: string) {
    const systemPrompt = `You are analyzing survey responses about ${context}. 
    Provide a structured analysis with the following:
    1. Key themes identified
    2. Sentiment analysis (positive/negative/neutral)
    3. Cultural context identification
    4. Any notable patterns or insights
    Return the analysis in JSON format.`;

    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': ANTHROPIC_API_KEY,
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
                model: 'claude-3-sonnet-20240229',
                max_tokens: 1024,
                messages: [{
                    role: 'user',
                    content: `${systemPrompt}\n\nAnalyze this response: "${openEndedResponse}"`
                }]
            })
        });

        const data = await response.json();
        return data;

    } catch (error) {
        console.error('Error analyzing survey response:', error);
        throw new Error('Failed to analyze survey response');
    }
}

async function batchAnalyzeSurveyResponses(responses: Array<{ id: string, response: string }>, context: string) {
    const analysisResults = await Promise.all(
        responses.map(async (item) => {
            const analysis = await analyzeSurveyResponse(item.response, context);
            return {
                responseId: item.id,
                analysis
            };
        })
    );

    return {
        analyzedAt: new Date(),
        results: analysisResults,
        summary: await generateAnalysisSummary(analysisResults)
    };
}